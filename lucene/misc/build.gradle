/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import org.gradle.internal.os.OperatingSystem

description = 'Index tools and other miscellaneous code'

dependencies {
  moduleApi project(':lucene:core')
  moduleTestImplementation project(':lucene:test-framework')
}

def os = OperatingSystem.current()
def sharedLibExt = os.isMacOsX() ? "dylib" : "so"
def sharedLibName = "libdotProduct.${sharedLibExt}"
def cc = System.getenv("CC") ?: "gcc"
def osArch = System.getProperty("os.arch")

// Native build task
tasks.register("buildNative", Exec) {
  group = "build"

  def outputDir = file("$buildDir/libs/dotProduct/shared")
  def outputFile = new File(outputDir, sharedLibName)

  inputs.files fileTree("src/c") { include("**/*.c") }
  outputs.file outputFile

  println "OSArch"
  println osArch

  doFirst {
    outputDir.mkdirs()
  }


  def srcFiles = fileTree("src/c") {
    include("**/*.c")
  }.files*.path

  commandLine = [cc, "-shared", "-O3", "-fPIC", "-march=native", "-funroll-loops", "-o", outputFile.absolutePath] + srcFiles

  doLast {
    def targetDir = rootProject.file("build/lib")
    // Copy the built shared library to the target directory
    println "Copying $sharedLibName to $targetDir"
    copy {
      from outputDir
      into targetDir
      include sharedLibName
    }
  }
}

tasks.register("debugInfo", Exec) {
    commandLine 'gcc', '--version'
    doFirst {
        println "Printing GCC version..."
    }
    // Print output to console
    standardOutput = System.out
}



tasks.register("buildNativeLib") {
  dependsOn "debugInfo"
  dependsOn tasks.named("buildNative")
}

tasks.named("assemble").configure {
  dependsOn tasks.named("buildNativeLib")
}
