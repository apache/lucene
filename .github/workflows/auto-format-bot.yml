name: "Format Bot"

on:
  issue_comment:
    types: [created]

env:
  DEVELOCITY_ACCESS_KEY: ${{ secrets.DEVELOCITY_ACCESS_KEY }}

jobs:
  format-fix:
    name: Apply formatting fixes
    # Only run on pull request comments and when the comment contains the trigger phrase
    if: |
      github.event.issue.pull_request &&
      (contains(github.event.comment.body, '@lucene-format-bot apply') ||
       contains(github.event.comment.body, '/format-fix'))

    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Get PR details
        id: pr_details
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              head_ref: pr.head.ref,
              head_sha: pr.head.sha,
              base_ref: pr.base.ref,
              repo_full_name: pr.head.repo.full_name,
              repo_clone_url: pr.head.repo.clone_url
            };

      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Correct git autocrlf
        run: git config --global core.autocrlf false

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ fromJson(steps.pr_details.outputs.result).repo_full_name }}
          ref: ${{ fromJson(steps.pr_details.outputs.result).head_ref }}
          fetch-depth: 0

      - uses: ./.github/actions/prepare-for-build

      - name: Install eclint
        uses: ./.github/actions/eclint

      - name: Install ast-grep
        run: |
          npm -g i @ast-grep/cli
          echo "lucene.tool.ast-grep=ast-grep" >> build-options.local.properties

      - name: Check formatting before fixes
        id: check_before
        run: |
          echo "Checking current formatting status..."
          set +e
          ./gradlew check -x test "-Ptask.times=true" --max-workers 2
          exit_code=$?
          echo "initial_check_passed=$([[ $exit_code -eq 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          exit 0

      - name: Apply formatting fixes
        if: steps.check_before.outputs.initial_check_passed == 'false'
        run: |
          echo "Applying formatting fixes..."
          ./gradlew tidy "-Ptask.times=true" --max-workers 2
          echo "Applying EditorConfig fixes (removing trailing whitespace)..."
          # Remove trailing whitespace from all tracked files (handle filenames with spaces)
          git ls-files -z | xargs -0 sed -i 's/[[:space:]]*$//'

      - name: Check if any files were changed
        id: git_changes
        if: steps.check_before.outputs.initial_check_passed == 'false'
        run: |
          if git diff --quiet; then
            echo "No changes were made by formatting fixes"
            echo "changes_made=false" >> $GITHUB_OUTPUT
          else
            echo "Changes were made by formatting fixes"
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "Changed files:"
            git diff --name-only
          fi

      - name: Verify formatting fixes
        id: check_after
        if: steps.check_before.outputs.initial_check_passed == 'false' && steps.git_changes.outputs.changes_made == 'true'
        run: |
          echo "Verifying formatting fixes..."
          set +e
          ./gradlew check -x test "-Ptask.times=true" --max-workers 2
          exit_code=$?
          echo "final_check_passed=$([[ $exit_code -eq 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          if [[ $exit_code -eq 0 ]]; then
            echo "‚úÖ Formatting validation passed after fixes"
          else
            echo "‚ùå Formatting validation still failing after fixes"
          fi
          exit 0

      - name: Create fix branch and commit
        id: create_fix_branch
        if: |
          steps.check_before.outputs.initial_check_passed == 'false' &&
          steps.git_changes.outputs.changes_made == 'true' &&
          steps.check_after.outputs.final_check_passed == 'true'
        run: |
          # Create a new branch for the fixes
          fix_branch="format-fixes-${{ fromJson(steps.pr_details.outputs.result).head_ref }}-$(date +%s)"
          echo "fix_branch=$fix_branch" >> $GITHUB_OUTPUT

          git config --local user.email "action@github.com"
          git config --local user.name "Lucene Format Bot"

          git checkout -b "$fix_branch"
          git add -A
          git commit -m "Apply automatic formatting fixes

          Fixes applied by @lucene-format-bot in response to:
          ${{ github.event.comment.html_url }}

          Original PR: #${{ github.event.issue.number }}

          Changes:
          $(git diff --name-only HEAD~1)"

      - name: Push fix branch
        if: |
          steps.check_before.outputs.initial_check_passed == 'false' &&
          steps.git_changes.outputs.changes_made == 'true' &&
          steps.check_after.outputs.final_check_passed == 'true'
        run: |
          git push origin ${{ steps.create_fix_branch.outputs.fix_branch }}

      - name: Create PR for fixes
        id: create_pr
        if: |
          steps.check_before.outputs.initial_check_passed == 'false' &&
          steps.git_changes.outputs.changes_made == 'true' &&
          steps.check_after.outputs.final_check_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: fixPr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ü§ñ Apply formatting fixes to #${{ github.event.issue.number }}`,
              head: '${{ steps.create_fix_branch.outputs.fix_branch }}',
              base: '${{ fromJson(steps.pr_details.outputs.result).head_ref }}',
              body: `## Automatic Formatting Fixes

            This PR applies automatic formatting fixes to address validation failures in #${{ github.event.issue.number }}.

            ### üîß Changes Applied
            - ‚úÖ Code formatting via \`./gradlew tidy\`
            - ‚úÖ Java code formatted with google-java-format
            - ‚úÖ Gradle/Groovy scripts formatted with spotless
            - ‚úÖ EditorConfig fixes (trailing whitespace removal)
            - ‚úÖ All formatting validation checks now pass

            ### üìù Details
            - **Triggered by**: ${{ github.event.comment.html_url }}
            - **Original PR**: #${{ github.event.issue.number }}
            - **Fix branch**: \`${{ steps.create_fix_branch.outputs.fix_branch }}\`

            ### üöÄ Next Steps
            Review and merge this PR to apply the formatting fixes to the original branch.

            ---
            *This PR was created automatically by the Lucene Format Bot ü§ñ*`
            });

            return {
              number: fixPr.number,
              html_url: fixPr.html_url
            };

      - name: Comment on original PR with success
        if: |
          steps.check_before.outputs.initial_check_passed == 'false' &&
          steps.git_changes.outputs.changes_made == 'true' &&
          steps.check_after.outputs.final_check_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fixPr = ${{ steps.create_pr.outputs.result }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ü§ñ **Format Bot Results**

            ‚úÖ **Formatting fixes applied successfully!**

            New PR with the formatting fixes: **#${fixPr.number}**

            ---
            *To trigger the format bot again, comment \`@lucene-format-bot apply\` or \`/format-fix\`*`
            });

      - name: Comment on original PR with no changes needed
        if: steps.check_before.outputs.initial_check_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ü§ñ **Format Bot Results**

            ‚úÖ **No formatting issues found!**

            Your code already complies with the project's formatting standards. No changes are needed.

            ---
            *To trigger the format bot again, comment \`@lucene-format-bot apply\` or \`/format-fix\`*`
            });

      - name: Comment on original PR with no changes made
        if: |
          steps.check_before.outputs.initial_check_passed == 'false' &&
          steps.git_changes.outputs.changes_made == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ü§ñ **Format Bot Results**

            ‚ö†Ô∏è **Formatting issues detected, but no automatic fixes available**

            The formatting validation failed, but running \`./gradlew tidy\` did not produce any changes. This might indicate:
            - Issues that cannot be automatically fixed
            - Problems with the build configuration
            - Non-formatting validation failures

            **Recommendation:** Please review the validation failures manually and apply fixes as needed.

            ---
            *To trigger the format bot again, comment \`@lucene-format-bot apply\` or \`/format-fix\`*`
            });

      - name: Comment on original PR with fix failures
        if: |
          steps.check_before.outputs.initial_check_passed == 'false' &&
          steps.git_changes.outputs.changes_made == 'true' &&
          steps.check_after.outputs.final_check_passed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ü§ñ **Format Bot Results**

            ‚ùå **Formatting fixes applied, but validation still failing**

            Formatting fixes were applied using \`./gradlew tidy\`, but the validation checks are still failing. This suggests there may be:
            - Additional formatting issues that cannot be automatically fixed
            - Non-formatting validation problems
            - Build or configuration issues

            **Recommendation:** Please review the validation failures manually and apply additional fixes as needed.

            ---
            *To trigger the format bot again, comment \`@lucene-format-bot apply\` or \`/format-fix\`*`
            });

      - name: Update reaction on completion
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            // Remove the eyes reaction and add thumbs up
            try {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'hooray'
              });
            } catch (error) {
              console.log('Could not add reaction:', error.message);
            }
