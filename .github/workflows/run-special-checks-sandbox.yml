name: "Run special checks: module lucene/sandbox"

on:
  workflow_dispatch:

  pull_request:
    branches:
      - '*'

  push:
    branches:
      - 'main'
      - 'branch_10x'

jobs:
  faiss-tests:
    name: tests for the Faiss codec (JDK ${{ matrix.java }} on ${{ matrix.os }})
    timeout-minutes: 15

    strategy:
      matrix:
        os: [ ubuntu-latest ]
        java: [ '23' ]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Setup Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: false
          auto-update-conda: true
          activate-environment: faiss
          channels: pytorch
          conda-remove-defaults: true
          miniforge-version: latest

      - name: Install Faiss
        # TODO: Uses the nightly version (@main) until v1.11.0 is released
        run: conda install pytorch/label/nightly::faiss-cpu

      - name: Checkout Lucene
        uses: actions/checkout@v4

      - name: Prepare Lucene workspace
        uses: ./.github/actions/prepare-for-build

      - name: Run tests for Faiss codec
        run: >
          LD_LIBRARY_PATH=$CONDA_PREFIX/lib
          ./gradlew -p lucene/sandbox
          -Dtests.faiss.run=true
          test --tests "org.apache.lucene.sandbox.codecs.faiss.*"

    defaults:
      run:
        shell: bash -el {0}
