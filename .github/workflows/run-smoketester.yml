name: Run smokeTestRelease.py against a release candidate

on:
  workflow_dispatch:
    inputs:
      artifacts-url:
        description: 'URL to artifacts, example: https://dist.apache.org/repos/dist/dev/lucene/lucene-...'
        type: string
        required: true

      gradle-java-version:
        description: "java version to run gradle with" 
        type: string
        required: true
        default: 11

      run-tests:
        description: "Include a test run" 
        type: boolean
        required: false
        default: false

jobs:
  smokeTestRelease:
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        java-version: [ '11' ]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          # TODO: shouldn't be needed but smoketester checks java version and we're on main.
          ref: 'branch_9_10'

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-package: jdk
          check-latest: true
          java-version: |
            17
            21
            22-ea
            ${{ inputs.gradle-java-version }}

      - name: Dump env variables
        run: set | grep "JAVA"

      - name: Run the smoke tester (${{ inputs.artifacts-url }})
        run: |
          python3 -u dev-tools/scripts/smokeTestRelease.py ${{ inputs.artifacts-url }} \
            ${{ inputs.run-tests && '-Dtests.filter="@skipall"' || '' }}
