name: "Run checks: module gradle/ (gradle upgrades)"

on:
  workflow_dispatch:

  pull_request:
    branches:
      - 'main'
      - 'branch_9x'
    paths:
      - '.github/workflows/run-checks-gradle-upgrade.yml'
      - 'gradle/wrapper/**'

  push:
    branches:
      - 'main'
      - 'branch_9x'
      - 'run-misc-gradle-tasks-on-upgrade'
    paths:
      - '.github/workflows/run-checks-gradle-upgrade.yml'
      - 'gradle/wrapper/**'

env:
  GRADLE_ENTERPRISE_ACCESS_KEY: ${{ secrets.GE_ACCESS_TOKEN }}

jobs:
  test:
    name: Run all kinds of gradle tasks
    timeout-minutes: 30

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/prepare-for-build

      # Required for generateEmojiTokenizationTestChecksumLoad.
      - run: sudo apt-get install libwww-perl
      - run: ./gradlew regenerate -x generateUAX29URLEmailTokenizerInternal --rerun-tasks
      - run: git reset --hard

      - run: ./gradlew testOpts
      - run: ./gradlew helpWorkflow
      - run: ./gradlew licenses updateLicenses
      - run: ./gradlew tidy
      - run: ./gradlew check -x test
      - run: ./gradlew assembleRelease mavenToLocal
      - run: ./gradlew getGeoNames
