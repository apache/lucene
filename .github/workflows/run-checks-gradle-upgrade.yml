name: "Run checks: module gradle/ (gradle upgrades)"

on:
  workflow_dispatch:

  pull_request:
    branches:
      - 'main'
      - 'branch_9x'
    paths:
      - '.github/workflows/run-checks-gradle-upgrade.yml'
      - 'gradle/wrapper/**'

  push:
    branches:
      - 'main'
      - 'branch_9x'
    paths:
      - '.github/workflows/run-checks-gradle-upgrade.yml'
      - 'gradle/wrapper/**'

env:
  GRADLE_ENTERPRISE_ACCESS_KEY: ${{ secrets.GE_ACCESS_TOKEN }}

jobs:
  test:
    name: Run all kinds of gradle tasks
    timeout-minutes: 30

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/prepare-for-build

      - name: ./gradlew regenerate
        run: |
          # add this package for generateEmojiTokenizationTestChecksumLoad.
          sudo apt-get install libwww-perl
          ./gradlew regenerate -x generateUAX29URLEmailTokenizerInternal --rerun-tasks
          if [ ! -z "$(git status --porcelain)" ]; then 
            echo ":warning: **regenerateleft local checkout in modified state**" >> $GITHUB_STEP_SUMMARY 
            echo '```' >> $GITHUB_STEP_SUMMARY
            git status --porcelain >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            git reset --hard && git clean -xfd .
          fi

      - run: ./gradlew testOpts
      - run: ./gradlew helpWorkflow
      - run: ./gradlew licenses updateLicenses
      - run: ./gradlew tidy
      - run: ./gradlew check -x test
      - run: ./gradlew assembleRelease mavenToLocal
      - run: ./gradlew getGeoNames
