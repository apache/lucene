import java.util.jar.JarFile

/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// Configure other things required for the java module system layer.

allprojects {
  plugins.withType(JavaPlugin) {
    // Configure the version attribute.
    tasks.withType(JavaCompile).configureEach{
      it.options.javaModuleVersion.set(provider {
        return project.version.toString()
      })
    }
  }

  // TODO: remove the hacks excluding java-module source folder from ecjLint and javadoc rendering.
}

configure(rootProject) {
  // Show all module names (for ease of debugging)
  tasks.register("showModuleNames", { showModuleTask ->
    def allJarTasks = []

    rootProject.subprojects.each { subproject ->
      subproject.tasks.matching { it.name == 'jar' }.all {
        allJarTasks.add it
      }
    }

    dependsOn allJarTasks

    doFirst {
      allJarTasks.each { jarTask ->
        File jarFile = jarTask.outputs.files.singleFile
        try (def jar = new JarFile(jarFile)) {
          logger.lifecycle(String.format(Locale.ROOT,
              "%-50s -> %s",
              jarFile.name,
              jar.manifest.mainAttributes.getValue("Automatic-Module-Name")))
        }
      }
    }
  })
}

allprojects {
  // Show all non-empty package names
  // There should be a better way...
  plugins.withType(JavaPlugin) {
    tasks.register("showPackageNames", { task ->
      doFirst {
        var pkgNameSet = [] as Set<String>
        sourceSets.main.each { sourceSet ->
          var dirs = sourceSet.allJava.srcDirTrees.collect { it.dir.path.toString() }
          sourceSet.allJava.filter{ it.name != "module-info.java" && it.name != "package-info.java" }.each {srcFile ->
            var dir = dirs.findAll { srcFile.path.matches("^${it}/.*\$") }.get(0)
            var pkgName = srcFile.path.replaceFirst("${dir}/", "").replaceFirst("/${srcFile.name}\$", "").replace("/", ".")
            pkgNameSet.add(pkgName)
          }
        }
        var pkgNames = pkgNameSet as List<String>
        pkgNames.sort()
        pkgNames.each { println(it) }
      }
    })
  }
}

